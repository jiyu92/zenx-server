var app=angular.module("app",["ngAnimate","ngMaterial"]),ZenX={socket:null,socketRequests:{},version:window.version,modules:{},text:{},focusIndex:1,assets:{audio:{}}};app.config(["$mdThemingProvider","$controllerProvider",function(e,n){window.$controllerProvider=n,e.theme("default").primaryPalette("orange").accentPalette("yellow")}]),$(window).click(function(e){var n=$(e.target);if(n.is(".app-array > *"))return ZenX.gotoApp(n.attr("data-module-namespace"));if(n.is(":not(.user-block .user-img)")&&$(".user-menu").addClass("out"),n.is(".zenx-window .window-head .x")&&ZenX.closeWindow(n),n.is(".desktop,.dock")){var t=$("<div>");t.addClass("circle").css({top:e.pageY,left:e.pageX}),$(".desktop").append(t),$(".x-focus").removeClass("x-focus"),setTimeout(function(){t.remove()},1500)}if(n.is(".zenx-window .window-head .fs"))if(n.parents(".zenx-window").hasClass("fs"))n.parents(".zenx-window").removeClass("fs"),n.parents(".zenx-window").animate({width:n.parents(".zenx-window").css("min-width"),height:n.parents(".zenx-window").css("min-height"),top:window.innerHeight/2-n.parents(".zenx-window").css("min-height").split("px")[0]/2,left:window.innerWidth/2-n.parents(".zenx-window").css("min-width").split("px")[0]/2},500,"swing");else{var o=n.parents(".zenx-window");o.animate({top:"10px",left:"10px",width:window.innerWidth-22+"px",height:window.innerHeight-100+"px"},300,"swing").addClass("fs")}}),$(window).bind("mousedown",function(e){var n=$(e.target);n.is(".zenx-window:not(.x-focus) *")&&ZenX.focus(n.parents(".zenx-window")),n.is(".zenx-window > .resizer")&&($("html").addClass("resizing"),ZenX.RESIZING=n.parents(".zenx-window"),ZenX.RESIZING_START={x:e.pageX,y:e.pageY,eW:ZenX.RESIZING.width()+2,eH:ZenX.RESIZING.height()+2}),n.is(".zenx-window .window-head, .zenx-window .window-head .title")&&(ZenX.DRAGGING=n.parents(".zenx-window"),ZenX.DRAGGING_START={x:e.pageX,y:e.pageY,eX:ZenX.DRAGGING.offset().left,eY:ZenX.DRAGGING.offset().top})}),$(window).bind("mouseup",function(){ZenX.DRAGGING=null,ZenX.RESIZING=null,$("html.resizing").removeClass("resizing")}),$(window).bind("mousemove",function(e){if(ZenX.DRAGGING){var n=ZenX.DRAGGING,t=ZenX.DRAGGING_START,o=+t.eY+(e.pageY-t.y),s=+t.eX+(e.pageX-t.x),i={top:o+"px",left:s+"px"};0>o&&(i.top="0px"),0>s&&(i.left="0px"),o+n.height()+2>window.innerHeight&&(i.top=window.innerHeight-n.height()-2+"px"),s+n.width()+2>window.innerWidth&&(i.left=window.innerWidth-n.width()-2+"px"),n.css(i)}if(ZenX.RESIZING){var n=ZenX.RESIZING,t=ZenX.RESIZING_START,a=+t.eW+(e.pageX-t.x),l=+t.eH+(e.pageY-t.y),i={width:a+"px",height:l+"px"};a+n.offset().left>window.innerWidth&&(i.width=window.innerWidth-n.offset().left+"px"),l+n.offset().top>window.innerHeight&&(i.height=window.innerHeight-n.offset().top+"px"),n.css(i).removeClass("fs")}}),$(document).bind("touchstart touchend touchmove",function(e){return e.preventDefault(),e.stopPropagation(),!1}),ZenX.winLoading=function(e,n){n?$(e).find(".win-spinner.out").removeClass("out"):$(e).find(".win-spinner:not(.out)").addClass("out")},app.controller("desktop",["$scope","$compile","$timeout","$rootScope",function(e,n,t,o){ZenX.log("Version "+ZenX.version),ZenX.clock=setInterval(function(){$(".user-block .clock").html((new Date).getHours()+":"+((new Date).getMinutes()<10?"0":"")+(new Date).getMinutes())},1e3),setInterval(function(){ZenX.send({api:"core",request:"refresh-session"}).success(function(e){ZenX.csrf=e.session_token})},5e4),e.text={},ZenX.updateText=function(){e.text=this.text},e.toggleUserMenu=function(){$(".user-menu").toggleClass("out")},window.deCompile=n,window.deScope=e,ZenX.createWindow=function(o){var s=$(o.parent?o.parent:".desktop > .pool"),i=$(".window-template").clone(),a=o.width||400,l=o.height||350,r=void 0==o.focus?!0:o.focus;i.addClass("zenx-window").removeClass("window-template out").css({width:a+"px",height:l+"px",minWidth:(a<(o.minWidth||400)?a:o.minWidth||400)+"px",minHeight:(l<(o.minHeight||400)?l:o.minHeight||400)+"px",top:"calc(50% - "+l/2+"px)",left:"calc(50% - "+a/2+"px)"}),i.find(".title").html(o.title||""),s.append(i),"string"==typeof o.template?(o.template='<div class="win-spinner ani02 out"><div class="app-spinner ng-scope"></div></div>'+(o.template||""),t(function(){e.$apply(function(){var t=n(o.template)(e);i.find(".window-content").append(t),o.callback&&o.callback(i)})},0)):(i.find(".window-content").append(o.template||""),o.callback&&o.callback(i)),(void 0==o.resizable||o.resizable)&&i.append('<div class="resizer"></div>'),r&&ZenX.focus(i),void 0==o.maximizable||o.maximizable||i.find(".window-head .fs").addClass("disabled")},ZenX.confirm=function(e,n,t){var o=$(".dialog-template").clone(),s=function(){ZenX.closeWindow(this)};o.find(".title").html(e.title),o.find(".message").html(e.message),o.find(".yes").html(e.buttons.split(" ")[0]),o.find(".no").html(e.buttons.split(" ")[1]),this.createWindow({title:e.windowTitle,width:300,height:165,resizable:!1,maximizable:!1,parent:"body",template:o.removeClass("dialog-template out").addClass("confirm-content"),callback:function(o){o.find(".yes").click(s).click(n||function(){}).focus(),o.find(".no").click(s).click(t||function(){}),e.callback&&e.callback(o)}})},ZenX.alert=function(e){var n=$(".dialog-template").clone(),t=function(){ZenX.closeWindow(this)};n.find(".title").html(e.title),n.find(".message").html(e.message),n.find(".yes").html(e.buttons.split(" ")[0]),n.find(".no").remove(),this.createWindow({title:e.windowTitle,width:300,height:165,resizable:!1,maximizable:!1,parent:"body",template:n.removeClass("dialog-template out").addClass("confirm-content"),callback:function(n){n.find(".yes").click(t).focus(),e.callback&&e.callback(n)}})},ZenX.focus=function(e){"string"==typeof e&&(e=$(e)),$(".x-focus").removeClass("x-focus"),e.addClass("x-focus").css("z-index",++ZenX.focusIndex)},ZenX.closeWindow=function(e){var n=$(e).is(".zenx-window")?$(e):$(e).parents(".zenx-window");n.addClass("closing"),t(function(){n.remove()},250)},e.logout=function(){$('.zenx-window[data-id="logout"]').length?ZenX.focus($('.zenx-window[data-id="logout"]')):ZenX.confirm({windowTitle:"ZenX Manager",title:ZenX.text.LOGOUT,message:ZenX.text.CONFIRM_LOGOUT,buttons:"yes no",callback:function(e){e.attr("data-id","logout")}},function(){ZenX.log("Destroying token..."),$(".loading-status").html(ZenX.text.LOGGING_OUT),$(".desktop").addClass("out"),localStorage.removeItem("session_token"),ZenX.socket.send(JSON.stringify({api:"core",request:"purge-token",token:ZenX.token})),ZenX.LOGGING_OUT=!0,ZenX.socket.close(),delete ZenX.socket,ZenX.modules={},delete ZenX.token,$(".zenx-window").each(function(e,n){ZenX.closeWindow(n)}),ZenX.focusIndex=1,t(function(){ZenX.log("Logout successful."),o.showLogin()},1e3)})},$(".user-menu .settings").click(function(){return $('.zenx-window[data-module="settings"]').length?ZenX.focus($('.zenx-window[data-module="settings"]')):void ZenX.createWindow({width:600,height:400,minWidth:600,minHeight:600,title:ZenX.text.SETTINGS,template:'<div class="out ani02" ng-controller="settings"></div>',callback:function(e){e.attr("data-module","settings"),ZenX.winLoading(e,!0)}})})}]),app.controller("login",["$scope","$timeout","$http","$rootScope",function(e,n,t,o){function s(){$(".loading-status").addClass("out"),$(".login-dialog *").attr("disabled",!1),$(".login-dialog").css("opacity",1).removeClass("pending"),$("body > .spinner").addClass("out")}function i(){$(".login-dialog *").attr("disabled",!1),$(".login-dialog").css("opacity",0).removeClass("pending")}function a(){$(".loading-status").addClass("out"),$(".login-dialog *").attr("disabled",!0),$(".login-dialog").css("opacity",1).addClass("pending"),$("body > .spinner:not(.out)").addClass("out")}function l(e){function n(t){ZenX.log("Starting new WebSocket connection..."),ZenX.socket=new WebSocket("wss://"+window.location.host),ZenX.socket.onopen=function(){ZenX.log("WebSocket connected. Getting auth...");({api:"core",request:"ws-auth",token:e.token,ws:!0});$(".user-block .connected-light").removeClass("offline"),"success"!=e.message?ZenX.log("Auth failed: ",e):(ZenX.log("Auth successful. Socket healthy."),"function"==typeof t&&t()),ZenX.socket.onmessage=function(e){var e=JSON.parse(e.data),n=ZenX.socketRequests[e.requestID];n.onsuccess(e),!isNaN(n.timeoutFn)&&clearTimeout(n.timeoutFn),n.persistent||delete ZenX.socketRequests[e.requestID]}},ZenX.socket.onerror=function(e){ZenX.log("WebSocket error: ",e)},ZenX.socket.onclose=function(){for(var e in ZenX.socketRequests){try{clearTimeout(ZenX.socketRequests[e].timeoutFn),ZenX.socketRequests[e].onerror({error:"connection_dropped"})}catch(t){}delete ZenX.socketRequests[e]}return ZenX.LOGGING_OUT?delete ZenX.LOGGING_OUT:(ZenX.log("WebSocket dropped. Reconnecting..."),$(".user-block .connected-light").addClass("offline"),void n())}}function t(){$(".loading-status").html(ZenX.text.INITIALIZE_ASSETS),ZenX.log("Loading assets...");var e=[],n=[ZenX.user.profileImage||"images/default.gif",ZenX.user.backgroundImage||"images/bg3.jpg"],t=["audio/newmsg.ogg","audio/start.ogg"],s=0;$(".app-array").html("");for(var i in ZenX.user.modules)n.push("modules/"+i+"/icon.png"),$(".app-array").append('<img data-module-namespace="'+i+'" src="modules/'+i+'/icon.png" />');n.forEach(function(n){var t=new Image;t.src=n,e.push(t)}),t.forEach(function(e){var n=new Audio;n.src=e,ZenX.assets.audio[e]=n}),e.forEach(function(n){var t=$(n).is("audio")?"oncanplaythrough":"onload";n[t]=function(){ZenX.log("Loaded asset: ",this),++s==e.length&&(ZenX.log("Loaded "+e.length+" assets."),o())}})}function o(){ZenX.log("Initialization complete. Welcome!"),ZenX.assets.audio["audio/start.ogg"].play(),$(".user-block .user-img").css("background-image","url("+(ZenX.user.profileImage||"images/default.gif")+")"),$(".desktop").removeClass("out").css("background-image","url("+(e.user.backgroundImage||"images/bg3.jpg")+")")}ZenX.token=e.token,ZenX.text=e.text,ZenX.user=e.user,ZenX.updateText(),$("body > .spinner, .loading-status").removeClass("out"),$(".loading-status").html(ZenX.text.INITIALIZE_CONNECTING_WEBSOCKET),n(function(){function e(s){$("head").append('<link href="/modules/'+s+'/styles.css" rel="stylesheet" type="text/css">'),$.getScript("/modules/"+s+"/main.js").done(function(){++n==o&&(ZenX.log("Loaded "+o+" modules."),t())}).fail(function(){e(s)})}var n=0,o=0;for(var s in ZenX.user.modules)o++;$(".loading-status").html(ZenX.text.INITIALIZE_MODULES),ZenX.log("Loading modules...");for(var s in ZenX.user.modules)e(s)})}i(),o.showLogin=s,window.hit=function(e){t.post("api",e).success(function(e){console.log(e)})};var r=new Image;r.src="/images/logo.png",ZenX.send({api:"core",request:"auth"}).success(function(e){"success"!=e.message?(ZenX.log("Authentication unsuccessful: ",e),s()):(ZenX.log("Authentication successful. Initializing..."),ZenX.log("Login data: ",e),l(e))}).error(s),e.rememberMe=!0,e.showTooltip=!1,$('input[name="username"]').focus(),e.login=function(){return e.username&&e.password?(e.showTooltip=!1,a(),ZenX.log("Attempting to log in..."),void ZenX.send({request:"login",username:e.username,password:String(CryptoJS.MD5(e.password)),api:"core"}).success(function(n){"success"!=n.message?(ZenX.log("Login unsuccessful: ",n),ZenX.alert({windowTitle:"ZenX Manager",title:"Login failed: Wrong credentials",message:"Please make sure you entered your credentials correctly and try again.",buttons:"ok"}),s()):(ZenX.log("Successful login. Initializing..."),ZenX.log("Login data: ",n),e.username="",e.password="",i(),l(n))}).error(function(e){ZenX.log("Login failed with error: ",e),ZenX.alert({windowTitle:"ZenX Manager",title:"Login failed",message:"An error occured. Please try again later.",buttons:"ok"}),s()})):e.showTooltip=!0}}]),app.controller("settings",["$scope","$rootScope","$timeout","$compile","$http",function(e,n,t,o,s){var i;ZenX.log("Started settings controller."),e.ZenX=ZenX,e.vp={data:{},noChanges:!0},i=e.vp,e.text=ZenX.text,function a(){ZenX.log("Loading settings template..."),ZenX.send({api:"core",request:"settings-template"}).success(function(n){"success"==n.message?(e.data=n.modules,e.$apply(function(){var s=o(n.template)(e);$('[ng-controller="settings"]').html(s).removeClass("out"),ZenX.winLoading('.zenx-window[data-module="settings"]',!1),t(function(){$(s).find(".tab").click(function(){$(".tab.selected").removeClass("selected"),$(this).addClass("selected")})},0)})):ZenX.log("Template failed to load with response: ",n)}).error(function(e){ZenX.log("Failed to load settings template with error: ",e),ZenX.log("Retrying to load settings template..."),t(a,2e3)})}(),e.getSettings=function(n,t,s){ZenX.winLoading('.zenx-window[data-module="settings"]',!0),0===n&&(n=$(this).attr("data-module-ns")),ZenX.send({api:"core",request:"settings-vp",template:n,isModule:t}).success(function(s){"user"!=n||t||(i.data.first_name=ZenX.user.first_name,i.data.last_name=ZenX.user.last_name,i.data.username=ZenX.user.username,i.data.email=ZenX.user.email,i.noChanges=!0),e.$apply(function(){"string"!=typeof s.template&&(s.template=ZenX.moduleSettings(s.template,n));var t=o(s.template)(e);$('[ng-controller="settings"] .viewport').html(t).removeClass("out"),ZenX.winLoading('.zenx-window[data-module="settings"]',!1)}),$('[ng-controller="settings"] .viewport input').bind("keyup keydown click",function(){i.noChanges=!1,e.$apply()})})},e.readFiles=function(e){var n=new FileReader,t=e.target.files[0];n.onload=function(e){$('[data-module="settings"] .viewport .img').css("background-image","url("+e.target.result+")")},n.readAsDataURL(t);var o=new FormData,s=new XMLHttpRequest;s.open("POST",window.location.origin+"/api"),s.upload.onprogress=function(e){if(e.lengthComputable){e.loaded/e.total*100|0}},s.onload=function(e){ZenX.user.profileImage=JSON.parse(e.target.response).profileImage,$(".user-block .user-img").css("background-image","url("+ZenX.user.profileImage+")")},o.append("file",t),o.append("api","core"),o.append("request","user-change-image"),s.setRequestHeader("x-csrf-token",ZenX.csrf),s.send(o)},e.saveUserSettings=function(){ZenX.winLoading('.zenx-window[data-module="settings"]',!0),i.data.password=i.data.password&&String(CryptoJS.MD5(i.data.password)),ZenX.send({api:"core",request:"change-user-settings",settings:i.data}).success(function(){ZenX.user.first_name=i.data.first_name,ZenX.user.last_name=i.data.last_name,ZenX.user.username=i.data.username,ZenX.user.email=i.data.email,ZenX.winLoading('.zenx-window[data-module="settings"]',!1),i.noChanges=!0,i.data.password="",e.$apply()})}}]),ZenX.gotoApp=function(e){$('[data-module="'+e+'"]').length?ZenX.focus('[data-module="'+e+'"]'):ZenX.startApp(e)},ZenX.log=function(e,n){"string"!=typeof e&&(n=e);var t="color:white;             font-size: 14px; text-shadow: 1px 1px 1px #999, -1px 1px 1px #999, -1px -1px 1px #999, 1px -1px 1px #999",o="color:yellow;            font-size: 14px; text-shadow: 1px 1px 1px #999, -1px 1px 1px #999, -1px -1px 1px #999, 1px -1px 1px #999",s="color:white;             font-size: 14px; text-shadow: 1px 1px 1px #999, -1px 1px 1px #999, -1px -1px 1px #999, 1px -1px 1px #999",i="color: rgb(6, 152, 154); font-size: 12px;",a="%c[Zen%cX%c]%c "+("string"==typeof e?e:"");n?console.log(a,t,o,s,i,n):console.log(a,t,o,s,i)},ZenX.moduleSettings=function(e,n){function t(t){if(t in o&&"$label"==t){var s=ZenX.modules[n].text[e[t]];return'<div class="settings-label">'+s+"</div>"}return""}var o={$label:1,$group:1,$text:1},s="<div>";return Object.keys(e).forEach(function(e){var n=t(e);s+=n}),s+="</div>"},app.run(["$http","$rootScope",function(e,n){ZenX.send=function(n){if(this.socket&&this.socket.readyState){var t=n.api+":"+n.request+":"+(new Date).getTime();return n.requestID=t,ZenX.socketRequests[t]=n,n.success=function(e){return this.onsuccess=e,this},n.error=function(e){return this.onerror=e,this},ZenX.socket.send(JSON.stringify(n)),0===n.timeout||n.persistent||(n.timeoutFn=setTimeout(function(){n.onerror&&n.onerror({error:"websocket_timeout"}),delete ZenX.socketRequests[n.requestID]},n.timeout||1e4)),n}return n.ws?ZenX.log("Request canceled. No WebSocket available: ",n):e({method:"post",url:"/api",headers:{"x-csrf-token":ZenX.csrf},data:n})}}]),ZenX.startApp=function(e){ZenX.createWindow({width:600,height:400,minWidth:600,minHeight:600,title:ZenX.modules[e].text.MODULE_NAME,template:'<div class="out ani02" ng-controller="'+e+'"></div>',callback:function(n){n.attr("data-module",e),ZenX.winLoading(n,!0)}})};